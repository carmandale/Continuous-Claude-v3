#!/usr/bin/env bash
set -euo pipefail

usage() {
  cat <<'USAGE'
cc-artifact --mode <checkpoint|handoff|finalize> [options]

Options:
  --mode <type>           Required: checkpoint | handoff | finalize
  --bead <id>             Primary bead (required for handoff/finalize)
  --primary-bead <id>     Alias for --bead
  --session-name <name>   Optional full session name (bead + slug)
  --session-title <name>  Optional short human title (used to build session)
  --agent-id <id>         Optional agent identifier (defaults from env)
  --goal <text>           Optional goal (if omitted, placeholder is inserted)
  --now <text>            Optional current focus (if omitted, placeholder is inserted)
  --outcome <value>       Optional outcome (SUCCEEDED|PARTIAL_PLUS|PARTIAL_MINUS|FAILED)
  --non-interactive       Require goal/now/outcome and skip editor
  --no-edit               Do not open editor after generating the template
  --edit                  Open editor after generating the template (default)
  --stdout                Print template to stdout instead of writing a file
  --output <path>         Override output file path
  -h, --help              Show this help

Examples:
  cc-artifact --mode checkpoint
  cc-artifact --mode handoff --bead Continuous-Claude-v3-123 --session-title "auth refactor"
  cc-artifact --mode finalize --bead Continuous-Claude-v3-123 --session-title "auth refactor" --no-edit \
    --goal "Finalize unified artifacts" --now "All done" --outcome SUCCEEDED
USAGE
}

MODE=""
PRIMARY_BEAD=""
SESSION_NAME=""
SESSION_TITLE=""
AGENT_ID_VALUE=""
GOAL=""
NOW=""
OUTCOME=""
EDIT=1
EDIT_SET=0
NON_INTERACTIVE=0
STDOUT=0
OUTPUT_PATH=""

while [[ $# -gt 0 ]]; do
  case "$1" in
    --mode)
      MODE="${2:-}"; shift 2 ;;
    --bead|--primary-bead|--primary_bead)
      PRIMARY_BEAD="${2:-}"; shift 2 ;;
    --session-name|--session_name)
      SESSION_NAME="${2:-}"; shift 2 ;;
    --session-title|--session_title)
      SESSION_TITLE="${2:-}"; shift 2 ;;
    --agent-id|--agent_id)
      AGENT_ID_VALUE="${2:-}"; shift 2 ;;
    --goal)
      GOAL="${2:-}"; shift 2 ;;
    --now)
      NOW="${2:-}"; shift 2 ;;
    --outcome)
      OUTCOME="${2:-}"; shift 2 ;;
    --non-interactive|--noninteractive)
      NON_INTERACTIVE=1; EDIT=0; EDIT_SET=1; shift ;;
    --no-edit)
      EDIT=0; EDIT_SET=1; shift ;;
    --edit)
      EDIT=1; EDIT_SET=1; shift ;;
    --stdout)
      STDOUT=1; shift ;;
    --output)
      OUTPUT_PATH="${2:-}"; shift 2 ;;
    -h|--help)
      usage; exit 0 ;;
    *)
      echo "Unknown argument: $1" >&2
      usage
      exit 1
      ;;
  esac
done

if [[ -z "$MODE" ]]; then
  echo "Error: --mode is required" >&2
  usage
  exit 1
fi

case "$MODE" in
  checkpoint|handoff|finalize) ;;
  *)
    echo "Error: --mode must be checkpoint, handoff, or finalize" >&2
    exit 1
    ;;
 esac

if [[ -z "$AGENT_ID_VALUE" ]]; then
  for var in AGENT_ID CLAUDE_AGENT_ID CODEX_AGENT_ID OPENCODE_AGENT_ID PI_AGENT_ID; do
    value="${!var:-}"
    if [[ -n "$value" ]]; then
      AGENT_ID_VALUE="$value"
      break
    fi
  done
fi

if [[ "$MODE" == "handoff" || "$MODE" == "finalize" ]]; then
  if [[ -z "$PRIMARY_BEAD" ]]; then
    echo "Error: --bead is required for $MODE" >&2
    exit 1
  fi
fi

if [[ -n "$OUTCOME" ]]; then
  OUTCOME="${OUTCOME^^}"
  case "$OUTCOME" in
    SUCCEEDED|PARTIAL_PLUS|PARTIAL_MINUS|FAILED) ;;
    *)
      echo "Error: --outcome must be one of SUCCEEDED, PARTIAL_PLUS, PARTIAL_MINUS, FAILED" >&2
      exit 1
      ;;
  esac
fi

PROJECT_DIR="${CLAUDE_PROJECT_DIR:-$(pwd)}"
if git -C "$PROJECT_DIR" rev-parse --git-dir >/dev/null 2>&1; then
  PROJECT_DIR=$(git -C "$PROJECT_DIR" rev-parse --show-toplevel)
fi

ARTIFACT_DIR="$PROJECT_DIR/thoughts/shared/handoffs"

PYTHON_BIN=$(command -v python3 || command -v python || true)
if [[ -z "$PYTHON_BIN" ]]; then
  echo "Error: python3 (or python) is required to generate timestamps" >&2
  exit 1
fi

if [[ -n "$PRIMARY_BEAD" ]]; then
  if command -v bd >/dev/null 2>&1; then
    if ! bd show "$PRIMARY_BEAD" >/dev/null 2>&1; then
      echo "Error: bead not found: $PRIMARY_BEAD" >&2
      echo "Run: bd list --status in_progress --json" >&2
      exit 1
    fi
    in_progress=$("$PYTHON_BIN" - "$PRIMARY_BEAD" <<'PY'
import json
import subprocess
import sys

bead = sys.argv[1]
try:
    out = subprocess.check_output([
        "bd",
        "list",
        "--status",
        "in_progress",
        "--json",
    ], text=True)
    data = json.loads(out)
    ids = {item.get("id") for item in data}
    print("yes" if bead in ids else "no")
except Exception:
    print("unknown")
PY
)
    if [[ "$in_progress" == "no" ]]; then
      echo "Warning: bead '$PRIMARY_BEAD' is not in_progress. Consider: bd update $PRIMARY_BEAD --status=in_progress" >&2
    fi
  else
    echo "Warning: bd not found; skipping bead validation." >&2
  fi
fi

TIMESTAMP=$("$PYTHON_BIN" - <<'PY'
from datetime import datetime, timezone
print(datetime.now(timezone.utc).isoformat(timespec="milliseconds").replace("+00:00", "Z"))
PY
)

slugify() {
  echo "${1:-}" | tr '[:upper:]' '[:lower:]' | sed -E 's/[^a-z0-9]+/-/g; s/^-+|-+$//g'
}

if [[ -z "$SESSION_NAME" ]]; then
  if [[ -n "$PRIMARY_BEAD" ]]; then
    title_source="${SESSION_TITLE:-$GOAL}"
    if [[ -z "$title_source" ]]; then
      title_source="session"
    fi
    SESSION_NAME="${PRIMARY_BEAD}-$(slugify "$title_source")"
  elif [[ -n "$SESSION_TITLE" ]]; then
    SESSION_NAME="$(slugify "$SESSION_TITLE")"
  else
    echo "Error: --session-name (or --session-title) is required when no --bead is provided" >&2
    exit 1
  fi
fi

DATE_PART=$("$PYTHON_BIN" - <<PY
from datetime import datetime
import sys
ts = "${TIMESTAMP}"
dt = datetime.fromisoformat(ts.replace("Z", "+00:00"))
print(dt.strftime("%Y-%m-%d_%H-%M"))
PY
)

TITLE_SLUG="$(slugify "${SESSION_TITLE:-$GOAL}")"
if [[ -n "$PRIMARY_BEAD" && "$SESSION_NAME" == "${PRIMARY_BEAD}-"* ]]; then
  TITLE_SLUG="${SESSION_NAME#${PRIMARY_BEAD}-}"
fi
if [[ -z "$TITLE_SLUG" ]]; then
  TITLE_SLUG="$(slugify "$SESSION_NAME")"
fi
TITLE_SLUG="$(slugify "$TITLE_SLUG")"

FILENAME="${DATE_PART}_${TITLE_SLUG}_${MODE}.yaml"
FILE_PATH="${OUTPUT_PATH:-$ARTIFACT_DIR/$SESSION_NAME/$FILENAME}"

GIT_BRANCH=$(git -C "$PROJECT_DIR" rev-parse --abbrev-ref HEAD 2>/dev/null || true)
GIT_COMMIT=$(git -C "$PROJECT_DIR" rev-parse HEAD 2>/dev/null || true)
GIT_REMOTE=$(git -C "$PROJECT_DIR" remote get-url origin 2>/dev/null || true)

yaml_quote() {
  local value="${1:-}"
  value=${value//\\/\\\\}
  value=${value//"/\\"}
  printf '"%s"' "$value"
}

GOAL_VALUE=${GOAL:-"<TODO>"}
NOW_VALUE=${NOW:-"<TODO>"}
OUTCOME_VALUE=${OUTCOME:-"<TODO>"}

missing_required=()
if [[ -z "$GOAL" ]]; then
  missing_required+=("goal")
fi
if [[ -z "$NOW" ]]; then
  missing_required+=("now")
fi
if [[ -z "$OUTCOME" ]]; then
  missing_required+=("outcome")
fi

if [[ "$NON_INTERACTIVE" -eq 1 ]]; then
  if [[ ${#missing_required[@]} -gt 0 ]]; then
    echo "Error: --non-interactive requires --goal, --now, and --outcome (missing: ${missing_required[*]})" >&2
    exit 1
  fi
fi

if [[ "$EDIT" -eq 0 && ${#missing_required[@]} -gt 0 ]]; then
  echo "Error: --no-edit requires --goal, --now, and --outcome (missing: ${missing_required[*]})" >&2
  exit 1
fi

if [[ "$EDIT_SET" -eq 0 && ${#missing_required[@]} -eq 0 ]]; then
  EDIT=0
fi

CONTENT="---\n"
CONTENT+="schema_version: \"1.0.0\"\n"
CONTENT+="mode: ${MODE}\n"
CONTENT+="date: ${TIMESTAMP}\n"
CONTENT+="session: $(yaml_quote "$SESSION_NAME")\n"
CONTENT+="outcome: $(yaml_quote "$OUTCOME_VALUE")\n"
if [[ -n "$PRIMARY_BEAD" ]]; then
  CONTENT+="primary_bead: $(yaml_quote "$PRIMARY_BEAD")\n"
fi
if [[ -n "$AGENT_ID_VALUE" ]]; then
  CONTENT+="agent_id: $(yaml_quote "$AGENT_ID_VALUE")\n"
fi
CONTENT+="---\n\n"
CONTENT+="goal: $(yaml_quote "$GOAL_VALUE")\n"
CONTENT+="now: $(yaml_quote "$NOW_VALUE")\n"
CONTENT+="\n"
CONTENT+="# Optional fields (YAML)\n"
CONTENT+="# done_this_session:, next:, blockers:, questions:, decisions:, findings:, worked:, failed:, files:, test:, git:\n"
if [[ -n "$GIT_BRANCH" || -n "$GIT_COMMIT" || -n "$GIT_REMOTE" ]]; then
  CONTENT+="git:\n"
  if [[ -n "$GIT_BRANCH" ]]; then
    CONTENT+="  branch: $(yaml_quote "$GIT_BRANCH")\n"
  fi
  if [[ -n "$GIT_COMMIT" ]]; then
    CONTENT+="  commit: $(yaml_quote "$GIT_COMMIT")\n"
  fi
  if [[ -n "$GIT_REMOTE" ]]; then
    CONTENT+="  remote: $(yaml_quote "$GIT_REMOTE")\n"
  fi
fi

if [[ "$STDOUT" -eq 1 ]]; then
  printf "%b" "$CONTENT"
  exit 0
fi

mkdir -p "$(dirname "$FILE_PATH")"
printf "%b" "$CONTENT" > "$FILE_PATH"

if [[ "$EDIT" -eq 1 ]]; then
  "${EDITOR:-vi}" "$FILE_PATH"
fi

"$PYTHON_BIN" - "$FILE_PATH" "$MODE" <<'PY'
import sys
import re

path = sys.argv[1]
mode = sys.argv[2]

text = open(path, "r", encoding="utf-8").read()
match = re.search(r"^---\n(.*?)\n---", text, re.DOTALL)
if not match:
    print("Missing YAML frontmatter block", file=sys.stderr)
    sys.exit(1)

front = match.group(1).splitlines()
data = {}
for line in front:
    if not line.strip():
        continue
    if line.startswith("  "):
        continue
    if ":" not in line:
        continue
    key, _, value = line.partition(":")
    data[key.strip()] = value.strip().strip('"')

missing = []
for key in ("schema_version", "mode", "date", "session", "outcome"):
    value = data.get(key, "").strip()
    if not value or value in ("<TODO>", "TODO"):
        missing.append(key)

body = text[match.end():]
def extract_scalar(key):
    m = re.search(rf"^{key}:\s*(.+)$", body, re.MULTILINE)
    return m.group(1).strip().strip('"') if m else ""

goal_value = extract_scalar("goal")
now_value = extract_scalar("now")
if not goal_value or goal_value in ("<TODO>", "TODO"):
    missing.append("goal")
if not now_value or now_value in ("<TODO>", "TODO"):
    missing.append("now")

if missing:
    print("Missing required fields: " + ", ".join(missing), file=sys.stderr)
    sys.exit(1)

if data.get("mode") != mode:
    print(f"mode mismatch: expected {mode}", file=sys.stderr)
    sys.exit(1)

if mode in ("handoff", "finalize"):
    bead = data.get("primary_bead", "").strip()
    if not bead or bead in ("<TODO>", "TODO"):
        print("primary_bead is required for handoff/finalize", file=sys.stderr)
        sys.exit(1)
PY

echo "$FILE_PATH"
